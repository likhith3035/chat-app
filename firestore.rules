rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Function to check if the user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Function to check if the user is an admin
    function isAdmin() {
      // Allow specific admin emails
      return isAuthenticated() && (
        request.auth.token.email == 'kamilikhith@gmail.com' ||
        request.auth.token.email == 'admin@gmail.com'
      );
    }

    // --- COLLECTION GROUP RULES ---
    
    // Allow collection group query for messages (Required for Starred Messages feature)
    match /{path=**}/messages/{message} {
      allow read: if isAuthenticated() && 
                  (resource == null || request.auth.uid in resource.data.starredBy);
    }

    // --- PATH-SPECIFIC RULES ---

    match /artifacts/{appId}/public/data {
      
      // USERS COLLECTION
      match /users/{userId} {
        // Anyone authenticated can read user profiles, admins can read all
        allow read: if isAuthenticated() || isAdmin();
        // Users can only create/update their own profile, admins can edit all
        allow create, update: if (isAuthenticated() && request.auth.uid == userId) || isAdmin();
        // Nobody can delete users from the client side, admins can
        allow delete: if isAdmin();
      }

      // CHATS COLLECTION
      match /chats/{chatId} {
        // Users can read chats they are a participant in, or public rooms, admins read all
        allow read: if (isAuthenticated() && (
          request.auth.uid in resource.data.participants || 
          resource.data.public == true
        )) || isAdmin();
        
        // Users can create a chat if they are in the participants array
        allow create: if isAuthenticated() && request.auth.uid in request.resource.data.participants;
        
        // Users can update a chat (like adding themselves to a public room or updating lastMessage)
        // if they are authenticated, or if admin
        allow update: if isAuthenticated() || isAdmin();
        
        // Participants or admins can delete chats
        allow delete: if isAuthenticated() && (
          isAdmin() ||
          request.auth.uid in resource.data.participants
        );
        
        // MESSAGES SUBCOLLECTION
        match /messages/{messageId} {
          // Users can read messages if they have access to the parent chat
          allow read: if isAuthenticated() && (
            request.auth.uid in get(/databases/$(database)/documents/artifacts/$(appId)/public/data/chats/$(chatId)).data.participants ||
            get(/databases/$(database)/documents/artifacts/$(appId)/public/data/chats/$(chatId)).data.public == true
          );
          
          // Users can send messages if they are the sender and have access to the chat
          allow create: if isAuthenticated() && 
                        request.resource.data.senderId == request.auth.uid &&
                        (
                          request.auth.uid in get(/databases/$(database)/documents/artifacts/$(appId)/public/data/chats/$(chatId)).data.participants ||
                          get(/databases/$(database)/documents/artifacts/$(appId)/public/data/chats/$(chatId)).data.public == true
                        );
                        
          // Users can update messages (e.g. add reactions) if they are a participant in the chat
          allow update: if isAuthenticated() && (
            request.auth.uid in get(/databases/$(database)/documents/artifacts/$(appId)/public/data/chats/$(chatId)).data.participants ||
            get(/databases/$(database)/documents/artifacts/$(appId)/public/data/chats/$(chatId)).data.public == true
          );
                        
          // Users can delete their own messages
          allow delete: if isAuthenticated() && 
            request.auth.uid == resource.data.senderId;
        }
      }

      // BAN APPEALS COLLECTION
      match /ban_appeals/{appealId} {
        // Users can read their own appeals, admins can read all
        allow read: if (isAuthenticated() && resource.data.uid == request.auth.uid) || isAdmin();
        // Users can create an appeal for themselves
        allow create: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
        // Admins can update/resolve appeals, or delete
        allow update, delete: if isAdmin();
      }
    }
  }
}
